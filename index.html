<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>Masaar</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <style>
    /*================================
      1. GLOBAL & THEME VARIABLES
    ================================*/
    :root {
      /* Waze-inspired Theme */
      --bg-primary: #ffffff;      /* White */
      --bg-secondary: #f0f3f5;  /* Light grey */
      --text-primary: #333333;
      --text-secondary: #8a8a8a;
      --brand-primary: #3367d6; /* Google Blue / Strong Blue */
      --brand-secondary: #4285f4;
      --accent-green: #34a853;
      --accent-red: #ea4335;
      --accent-yellow: #fbbc05;
      --font-family: 'Rubik', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    html, body {
      height: 100%;
      background-color: #d0d0d0; /* BG behind the phone */
      font-family: var(--font-family);
      overflow: hidden;
    }

    /*================================
      2. PHONE & NAVIGATION
    ================================*/
    .phone {
      position: relative;
      width: 100%;
      height: 100%;
      max-width: 420px;
      max-height: 900px;
      margin: auto;
      background: var(--bg-secondary);
      border-radius: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid #c0c0c0;
    }

    .app-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      background: var(--bg-secondary);
    }

    .bottom-nav {
      display: flex;
      height: 65px;
      background: var(--bg-primary);
      border-top: 1px solid #e0e0e0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      z-index: 1000;
    }

    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 500;
      transition: color 0.2s ease;
    }
    .nav-btn i {
      font-size: 20px;
      margin-bottom: 2px;
    }
    .nav-btn.active {
      color: var(--brand-primary);
    }

    /* Page container */
    .page {
      animation: fadeIn 0.3s ease-out;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /*================================
      3. AUTHENTICATION PAGE
    ================================*/
    .auth-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 2rem;
      background: var(--bg-primary);
    }
    .auth-logo {
      width: 100px;
      height: 100px;
      margin-bottom: 2rem;
      border-radius: 20px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: var(--brand-primary);
    }
    .auth-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 12px;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: 50px;
      font-weight: 500;
      font-size: 1rem;
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color 0.2s ease;
    }
    .auth-btn:hover {
      background-color: #f7f7f7;
    }
    .auth-btn img {
      width: 24px;
      height: 24px;
      margin-right: 12px;
    }
    .auth-btn-guest {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-weight: 500;
      margin-top: 1rem;
    }

    /*================================
      4. HOME (SEARCH) PAGE
    ================================*/
    .home-container {
      position: relative;
      padding: 0;
      overflow: hidden;
    }
    
    #home-map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      filter: brightness(0.9); /* Dims the map slightly */
    }

    .home-ui-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      padding: 1rem;
      z-index: 10;
      overflow-y: auto;
      /* Prevents scrollbar from covering content */
      padding-right: 2rem;
    }
    
    .where-to-card {
      background: var(--bg-primary);
      border-radius: 16px;
      padding: 1.25rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .location-input {
      position: relative;
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-radius: 50px;
      font-weight: 500;
    }
    .location-input i {
      color: var(--text-secondary);
      margin-right: 12px;
    }
    .location-input.to {
      margin-top: 10px;
    }
    .location-input input {
      border: none;
      background: transparent;
      width: 100%;
      font-weight: 500;
      outline: none;
    }

    .quick-dest-list {
      background: var(--bg-primary);
      border-radius: 16px;
      padding: 0.5rem 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin-top: 1rem;
    }
    .quick-dest-item {
      display: flex;
      align-items: center;
      padding: 0.75rem 1.25rem;
      cursor: pointer;
      border-bottom: 1px solid var(--bg-secondary);
    }
    .quick-dest-item:last-child {
      border-bottom: none;
    }
    .quick-dest-item:hover {
      background: var(--bg-secondary);
    }
    .quick-dest-icon {
      font-size: 1rem;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      border-radius: 50%;
      margin-right: 1rem;
      color: var(--brand-primary);
    }
    .quick-dest-info {
      flex: 1;
    }
    .quick-dest-info h6 {
      font-weight: 500;
      margin: 0;
      color: var(--text-primary);
    }
    .quick-dest-info p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0;
    }

    /* This holds the route suggestions on the Home page */
    .route-suggestion-container {
        background: var(--bg-primary);
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        padding: 1rem;
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 20;
        max-height: 60%;
        overflow-y: auto;
    }
    .route-suggestion-card {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--bg-primary);
      border-radius: 12px;
      margin-bottom: 10px;
      border: 1px solid #eee;
      transition: box-shadow 0.2s ease;
      cursor: pointer;
    }
    .route-suggestion-card:hover {
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .route-icon {
      font-size: 1.5rem;
      margin-right: 1rem;
    }
    .route-details {
      flex: 1;
    }
    .route-time {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    .route-legs {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .route-points {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--accent-green);
    }
    .route-points i {
      font-size: 0.8rem;
      margin-right: 4px;
    }

    .booking-success {
      text-align: center;
      padding: 3rem 1rem;
      position: absolute;
      top: 50%;
      left: 1rem;
      right: 1rem;
      transform: translateY(-50%);
      background: var(--bg-primary);
      border-radius: 16px;
      z-index: 30;
    }
    .booking-success i {
      font-size: 4rem;
      color: var(--accent-green);
      margin-bottom: 1rem;
    }

    /*================================
      5. MAP (NAVIGATION) PAGE
    ================================*/
    .map-page {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .map-container-wrapper {
      flex: 1;
      position: relative;
      background: #e0e0e0; /* Map placeholder BG */
    }
    
    .map-placeholder {
      height: 100%;
      width: 100%;
      background: #e0e0e0; /* Fallback BG */
    }
    
    /* **THE FIX IS HERE (Part 1)**
      This CSS rule hides the plugin's default text panel
      but leaves the rest of its container (including the map line) visible.
    */
    .leaflet-routing-alternatives-container {
      display: none !important;
    }
    
    .where-to-toggle {
      position: absolute;
      top: 1rem;
      left: 1rem;
      right: 1rem;
      z-index: 10;
      padding: 14px 20px;
      background: var(--bg-primary);
      border: none;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-primary);
      text-align: left;
    }

    /* Crowd/Info Panel */
    .crowd-info-panel {
      padding: 1rem;
      background: var(--bg-primary);
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
      z-index: 5;
    }
    .crowd-stat {
      text-align: center;
    }
    .crowd-stat i {
      font-size: 1.5rem;
      color: var(--brand-primary);
    }
    .crowd-stat-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }
    .crowd-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    /* Heat Map styling */
    .heat-map-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-top: 1rem;
      margin-bottom: 0.5rem;
    }
    .vehicle-heatmap-container {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .vehicle-layout {
      border: 2px solid #ccc;
      border-radius: 10px;
      background: #fafafa;
      width: 100%;
      max-width: 300px;
      padding: 5px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
    }
    .vehicle-zone {
      height: 25px;
      border-radius: 4px;
      opacity: 0.8;
    }
    .zone-green { background: var(--accent-green); }
    .zone-yellow { background: var(--accent-yellow); }
    .zone-red { background: var(--accent-red); }
    /* Make some zones span columns for layout */
    .span-2 { grid-column: span 2; }
    .span-4 { grid-column: span 4; }
    /* End Heat Map */


    /* Live Vehicle Simulation */
    .live-vehicle {
      position: absolute;
      z-index: 20;
      padding: 4px;
      background: var(--bg-primary);
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: all 4s linear; /* Smooth movement */
    }
    .live-vehicle i {
      display: block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      text-align: center;
      line-height: 20px;
    }
    .vehicle-metro { background-color: var(--accent-red); }
    .vehicle-bus { background-color: var(--brand-primary); }
    .vehicle-tram { background-color: var(--accent-green); }

    /* Live Navigation Panel */
    .live-nav-panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      background: var(--bg-primary);
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .live-nav-header {
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
    }
    .live-nav-header h5 {
      margin: 0;
      font-weight: 700;
      font-size: 1.1rem;
    }
    .live-nav-details {
      font-size: 1rem;
      color: var(--text-secondary);
      margin: 0;
    }
    /* This holds the scrollable directions */
    .live-nav-directions {
      max-height: 200px;
      overflow-y: auto;
      padding: 0;
    }
    .direction-step {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--bg-secondary);
    }
    .direction-step:last-child {
      border-bottom: none;
    }
    .direction-step i {
      font-size: 1.2rem;
      color: var(--brand-primary);
    }
    .direction-step-text {
      font-weight: 500;
      flex: 1;
    }
    .direction-step-dist {
      font-weight: 500;
      color: var(--text-secondary);
    }
    /* End Navigation Panel */


    /*================================
      6. REWARDS PAGE
    ================================*/
    .rewards-page {
        padding: 0;
        background: var(--bg-secondary);
    }
    .rewards-header {
      padding: 1.5rem 1rem 1rem 1rem;
      text-align: center;
      background: var(--bg-primary);
      border-bottom: 1px solid #eee;
    }
    .rewards-header h2 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--brand-primary);
      margin: 0;
    }
    .rewards-header p {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin: 0;
    }
    .reward-category {
      padding: 1rem;
    }
    .reward-category h4 {
      font-weight: 700;
      font-size: 1.3rem;
      margin-bottom: 1rem;
    }
    .reward-card {
      display: flex;
      align-items: center;
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .reward-card-icon {
      font-size: 1.5rem;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-secondary);
      border-radius: 50%;
      margin-right: 1rem;
    }
    .reward-card-info {
      flex: 1;
    }
    .reward-card-info h6 {
      font-weight: 700;
      margin: 0;
    }
    .reward-card-info p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0;
    }
    .reward-card .btn {
      font-weight: 700;
      border-radius: 50px;
      font-size: 0.9rem;
      padding: 6px 14px;
    }

    /*================================
      7. PROFILE PAGE
    ================================*/
    .profile-page {
        padding: 0;
        background: var(--bg-secondary);
    }
    .profile-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem 1rem;
      background: var(--bg-primary);
    }
    .profile-img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-secondary);
      overflow: hidden;
    }
    .profile-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-info h4 {
      margin: 0;
      font-weight: 700;
    }
    .profile-info p {
      margin: 0;
      color: var(--text-secondary);
    }

    .nol-balance-card {
      margin: 1rem;
      padding: 1.25rem;
      background: var(--brand-primary);
      color: white;
      border-radius: 16px;
      box-shadow: 0 5px 20px rgba(51, 103, 214, 0.4);
    }
    .nol-balance-card h6 {
      margin: 0;
      font-weight: 400;
      opacity: 0.8;
    }
    .nol-balance-card h2 {
      margin: 0;
      font-weight: 700;
      font-size: 2.2rem;
    }

    .profile-list-group {
      margin: 1rem;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .profile-list-item {
      display: flex;
      align-items: center;
      padding: 1rem 1.25rem;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--bg-secondary);
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
    }
    .profile-list-item:last-child {
      border-bottom: none;
    }
    .profile-list-item i {
      font-size: 1.2rem;
      color: var(--text-secondary);
      width: 30px;
      text-align: left;
    }
    .profile-list-item span {
      flex: 1;
    }
    .profile-list-item .badge {
      font-size: 0.8rem;
    }
    .profile-list-item.logout {
      color: var(--accent-red);
    }

    /* Coupon History List */
    .coupon-item {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .coupon-item-info {
      flex: 1;
    }
    .coupon-item-info p {
      margin: 0;
      font-weight: 500;
    }
    .coupon-item-info small {
      margin: 0;
      color: var(--text-secondary);
    }
    .coupon-item-info .text-success { font-weight: 700; }
    .coupon-item-info .text-danger { font-weight: 700; }
  </style>
</head>

<body>

  <div class="phone">
    <main id="app-container" class="app-container"></main>

    <nav id="bottom-nav" class="bottom-nav" style="display: none;">
      <button class="nav-btn active" data-page="home">
        <i class="bi bi-house-door-fill"></i>
        <span>Home</span>
      </button>
      <button class="nav-btn" data-page="map">
        <i class="bi bi-map-fill"></i>
        <span>Map</span>
      </button>
      <button class="nav-btn" data-page="rewards">
        <i class="bi bi-star-fill"></i>
        <span>Rewards</span>
      </button>
      <button class="nav-btn" data-page="profile">
        <i class="bi bi-person-fill"></i>
        <span>Profile</span>
      </button>
    </nav>
  </div>

  <div class="modal fade" id="redeemModal" tabindex="-1" aria-labelledby="redeemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="redeemModalTitle">Redeem Coupon</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <p>Show this to the partner for verification.</p>
          <img id="redeemQR" src="" alt="QR Code" class="img-fluid mb-3" style="border-radius: 8px;">
          <img id="redeemBarcode" src="" alt="Barcode" class="img-fluid mb-4" style="height: 60px; width: 100%; object-fit: cover;">
          <p class="text-body-secondary small mb-0">Verification Link:</p>
          <a href="#" id="redeemLink" class="small" target="_blank"></a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    /**
     * Masaar App - All-in-One JavaScript
     */

    document.addEventListener('DOMContentLoaded', () => {

      //================================================================
      // 1. APPLICATION STATE & DATABASE
      //================================================================
      
      const state = {
        isLoggedIn: false,
        currentPage: 'home', // 'home', 'map', 'rewards', 'profile'
        user: {
          name: 'Welcome User',
          profileImg: null, 
          nolBalance: 0.00,
          totalPoints: 1420,
          tripHistory: [
            { id: 't1', type: 'metro', details: 'Union to Burj Khalifa', date: 'Today, 9:15 AM' },
            { id: 't2', type: 'bus', details: 'Bus 29 - Mall to Al Ghubaiba', date: 'Yesterday, 5:30 PM' },
            { id: 't3', type: 'tram', details: 'JBR 1 to Al Sufouh', date: 'Yesterday, 10:00 AM' },
          ],
          coupons: [
            { id: 'c1', name: '20% off Arabica', status: 'unused', expires: '3 days' },
            { id: 'c2', name: 'AED 10 off Carrefour', status: 'used', expires: '---' },
            { id: 'c3', name: '5% off Zara', status: 'expired', expires: 'Expired' },
          ]
        },
        planner: {
          from: 'Current Location',
          to: '',
          routes: [], 
          selectedRoute: null,
          bookingState: 'idle', // 'idle', 'routes', 'booked', 'navigating'
          directions: [], 
        },
        liveMap: {
          vehicleSimInterval: null,
          vehicles: [
            { id: 'm1', type: 'metro', icon: 'M', class: 'vehicle-metro', top: '20%', left: '10%' },
            { id: 'b1', type: 'bus', icon: 'B', class: 'vehicle-bus', top: '40%', left: '60%' },
            { id: 't1', type: 'tram', icon: 'T', class: 'vehicle-tram', top: '70%', left: '30%' },
          ]
        }
      };

      const DESTINATION_COORDS = {
  "Union Metro Station": [25.2697, 55.3075],
  "Burj Khalifa/Dubai Mall Metro": [25.1972, 55.2794],
  "Mall of the Emirates Metro": [25.1180, 55.2003],
  "Dubai Marina": [25.0780, 55.1330],
  "Al Ghubaiba Bus Station": [25.2634, 55.2983]
};
      // --- DUMMY DATA ---
      const MOCK_ROUTES = [
        { id: 'r1', time: '28 min', legs: 'Walk, Metro (Red)', points: 25, traffic: 'low', icon: 'ðŸš‡' },
        { id: 'r2', time: '35 min', legs: 'Walk, Bus (F11)', points: 15, traffic: 'moderate', icon: 'ðŸšŒ' },
        { id: 'r3', time: '42 min', legs: 'Walk, Metro (Green), Bus (29)', points: 40, traffic: 'low', icon: 'ðŸš‡' }
      ];

      const MOCK_REWARDS = {
        "CafÃ©s": [
          { id: 'rw1', name: '% Arabica', points: '500', icon: 'â˜•' },
          { id: 'rw2', name: 'Cupagahwa', points: '400', icon: 'â˜•' },
        ],
        "Groceries": [
          { id: 'rw3', name: 'Carrefour', points: '1000', icon: 'ðŸ›’' },
          { id: 'rw4', name: 'Lulu Hypermarket', points: '1000', icon: 'ðŸ›’' },
          { id: 'rw5', name: 'Union Coop', points: '800', icon: 'ðŸ›’' },
        ],
        "Clothing": [
          { id: 'rw6', name: 'Pull & Bear', points: '1500', icon: 'ðŸ‘•' },
          { id: 'rw7', name: 'Zara', points: '2000', icon: 'ðŸ‘•' },
        ],
        "Rides": [
          { id: 'rw8', name: 'Careem', points: '700', icon: 'ðŸš•' },
          { id: 'rw9', name: 'Uber', points: '700', icon: 'ðŸš•' },
          { id: 'rw10', name: 'Dubai Taxi', points: '600', icon: 'ðŸš•' },
        ]
      };
      
      const MOCK_DESTINATIONS = [
          { name: 'Union Metro Station', details: 'Red/Green Line Interchange', icon: 'ðŸš‡' },
          { name: 'Burj Khalifa/Dubai Mall Metro', details: 'Red Line', icon: 'ðŸš‡' },
          { name: 'Mall of the Emirates Metro', details: 'Red Line', icon: 'ðŸš‡' },
          { name: 'Dubai Marina', details: 'Tram/Metro Station', icon: 'ðŸš‹' },
          { name: 'Al Ghubaiba Bus Station', details: 'Main Bus Hub', icon: 'ðŸšŒ' },
      ];

      const LOGGED_IN_USER = {
        ...state.user,
        name: 'Mohammad Ibrahim',
        profileImg: 'Personal Pic.jpg',
        nolBalance: 42.50,
      };

      //================================================================
      // 2. DOM ELEMENT SELECTORS
      //================================================================
      
      const appContainer = document.getElementById('app-container');
      const bottomNav = document.getElementById('bottom-nav');
      
      const redeemModalEl = document.getElementById('redeemModal');
      const redeemModal = new bootstrap.Modal(redeemModalEl);
      const redeemModalTitle = document.getElementById('redeemModalTitle');

      // To hold the Leaflet map instances
      let homeMapInstance = null;
      let navMapInstance = null;
      let leafletRoutingControl = null;

      //================================================================
      // 3. CORE APP LOGIC (Rendering & Navigation)
      //================================================================

      function renderApp() {
        stopLiveVehicleSim();
        stopAllMaps(); 

        if (!state.isLoggedIn) {
          renderAuthentication();
          bottomNav.style.display = 'none';
        } else {
          bottomNav.style.display = 'flex';
          updateActiveNav();
          
          switch (state.currentPage) {
            case 'home':
              renderHomePage();
              break;
            case 'map':
              renderMapPage();
              break;
            case 'rewards':
              renderRewardsPage();
              break;
            case 'profile':
              renderProfilePage();
              break;
            default:
              renderHomePage();
          }
        }
      }

      function updateActiveNav() {
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.page === state.currentPage);
        });
      }

      function onNavClick(e) {
        const navButton = e.target.closest('.nav-btn');
        if (navButton) {
          const page = navButton.dataset.page;
          if (page !== state.currentPage) {
            state.currentPage = page;
            if (page !== 'map' && page !== 'home') {
              // Reset booking state when leaving map/home
              state.planner.bookingState = 'idle';
              state.planner.to = '';
              state.planner.directions = [];
            }
            renderApp();
          }
        }
      }
      
      bottomNav.addEventListener('click', onNavClick);

      //================================================================
      // 4. AUTHENTICATION PAGE
      //================================================================

      function renderAuthentication() {
        appContainer.innerHTML = `
          <div class="page auth-container">
            
            <img src="Masaar Logo.png" alt="Masaar Logo" style="width: 80px; height: 80px; margin-bottom: 1rem; border-radius: 16px;">
            
            <h2 class="fw-bold mb-4">Masaar</h2>
            
            <button class="auth-btn" data-auth="uaepass">
              <img src="uaepass.png" alt="UAE Pass" 
                  style="width: 24px; height: 24px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: white;"> 
              Sign in with UAE Pass
            </button>
            
            <button class="auth-btn" data-auth="google">
              <img src="google.png" alt="Google" 
                  style="width: 24px; height: 24px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: white;"> 
              Sign in with Google
            </button>
            
            <button class="auth-btn" data-auth="rta">
              <img src="rta.jpg" alt="Nol App" 
                  style="width: 24px; height: 24px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: white;"> 
              Sign in with RTA Nol App
            </button>
            
            <button class="auth-btn-guest" data-auth="guest">
              Continue as Guest
            </button>
          </div>
        `;

        appContainer.querySelectorAll('[data-auth]').forEach(btn => {
          btn.addEventListener('click', () => {
            handleLogin(btn.dataset.auth);
          });
        });
      }

      function handleLogin(authType) {
        if (authType === 'guest') {
          state.user = { 
            ...state.user,
            name: 'Welcome User',
            profileImg: null,
            nolBalance: 0.00,
          };
        } else {
          state.user = { ...LOGGED_IN_USER };
        }
        state.isLoggedIn = true;
        state.currentPage = 'home';
        renderApp();
      }
      
      function handleLogout() {
        state.isLoggedIn = false;
        state.user = {
          ...state.user,
          name: 'Welcome User',
          profileImg: null,
          nolBalance: 0.00,
        };
        state.planner.bookingState = 'idle';
        renderApp();
      }

      //================================================================
      // 5. HOME (SEARCH) PAGE
      //================================================================

      function renderHomePage() {
        let overlayContent = '';
        
        switch (state.planner.bookingState) {
          case 'routes':
            overlayContent = renderRouteSuggestions();
            break;
          case 'booked':
            overlayContent = renderBookingSuccess();
            break;
          case 'idle':
          default:
            overlayContent = renderPlannerInput();
        }
        
        appContainer.innerHTML = `
          <div class="page home-container">
            <div id="home-map" class="map-placeholder"></div>
            ${overlayContent}
          </div>
        `;
        
        initStaticMap('home-map');
        attachHomeListeners();
      }

      function renderPlannerInput() {
        return `
          <div class="home-ui-overlay">
            <div class="where-to-card">
              <h4 class="fw-bold mb-3">Where to?</h4>
              <div class="location-input from">
                <i class="bi bi-geo-alt-fill"></i>
                <span>${state.planner.from}</span>
              </div>
              <div class="location-input to" id="destination-input">
                <i class="bi bi-geo-fill"></i>
                <input type="text" id="destination-text" placeholder="Enter destination" value="${state.planner.to}">
              </div>
            </div>
            
            <h5 class="fw-bold mt-4 mb-2 text-primary">Quick Destinations</h5>
            <div class="quick-dest-list">
              ${MOCK_DESTINATIONS.map(dest => `
                <div class="quick-dest-item" data-destination="${dest.name}">
                  <div class="quick-dest-icon">${dest.icon}</div>
                  <div class="quick-dest-info">
                    <h6>${dest.name}</h6>
                    <p>${dest.details}</p>
                  </div>
                  <i class="bi bi-chevron-right text-secondary"></i>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      
      function renderRouteSuggestions() {
        const inputCard = renderPlannerInput(); 
        
        return `
          ${inputCard}
          <div class="route-suggestion-container">
            <div class="d-flex align-items-center mb-3">
              <button class="btn btn-light btn-sm rounded-circle me-2" id="back-to-planner">
                <i class="bi bi-arrow-left"></i>
              </button>
              <h5 class="fw-bold mb-0">Suggested Routes</h5>
            </div>
            
            ${state.planner.routes.map(route => `
              <div class="route-suggestion-card" data-route-id="${route.id}">
                <div class="route-icon">${route.icon}</div>
                <div class="route-details">
                  <div class="route-time">${route.time}</div>
                  <div class="route-legs">${route.legs}</div>
                </div>
                ${route.traffic === 'low' ? `
                  <div class="route-points">
                    <i class="bi bi-star-fill"></i> +${route.points}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        `;
      }

      function renderBookingSuccess() {
        console.log("Redirecting to RTA website for ticket purchase...");
        
        setTimeout(() => {
          if (state.currentPage !== 'home') return;
          
          appContainer.innerHTML = `
            <div class="page home-container">
              <div id="home-map" class="map-placeholder"></div>
              <div class="booking-success">
                <i class="bi bi-check-circle-fill"></i>
                <h3 class="fw-bold">Successfully Booked!</h3>
                <p class="text-secondary">Redirecting to live navigation...</p>
              </div>
            </div>
          `;
          initStaticMap('home-map');
          
          setTimeout(() => {
            if (state.currentPage !== 'home') return;
            state.planner.bookingState = 'navigating';
            state.currentPage = 'map'; // <-- SWITCH TO MAP TAB
            renderApp();
          }, 2000);
          
        }, 500); 
        
        return `<div class="home-ui-overlay d-flex align-items-center justify-content-center" style="height: 80%;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>`;
      }

      function attachHomeListeners() {
        const destInput = document.getElementById('destination-text');
        if (destInput) {
          destInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && destInput.value.trim() !== '') {
              startRouteSearch(destInput.value.trim());
            }
          });
        }
        
        appContainer.querySelectorAll('.quick-dest-item').forEach(item => {
            item.addEventListener('click', () => {
                const destinationName = item.dataset.destination;
                startRouteSearch(destinationName);
            });
        });

        const backBtn = document.getElementById('back-to-planner');
        if (backBtn) {
          backBtn.addEventListener('click', () => {
            state.planner.bookingState = 'idle';
            renderHomePage();
          });
        }

        appContainer.querySelectorAll('.route-suggestion-card').forEach(card => {
          card.addEventListener('click', () => {
            const routeId = card.dataset.routeId;
            state.planner.selectedRoute = state.planner.routes.find(r => r.id === routeId);
            state.planner.bookingState = 'booked';
            renderHomePage();
          });
        });
      }
      
      function startRouteSearch(destination) {
        state.planner.to = destination;
        state.planner.routes = MOCK_ROUTES;
        state.planner.bookingState = 'routes';
        renderHomePage();
      }

      //================================================================
      // 6. MAP (NAVIGATION) PAGE
      //================================================================

      function renderMapPage() {
        const isNavigating = state.planner.bookingState === 'navigating';
        const selectedRoute = state.planner.selectedRoute;

        appContainer.innerHTML = `
          <div class="page map-page">
            <div class="map-container-wrapper">
            
              <div id="nav-map" class="map-placeholder"></div>
              
              ${!isNavigating ? `
                <button class="where-to-toggle" id="where-to-btn">
                  Where to?
                </button>
              ` : ''}

              ${isNavigating && selectedRoute ? `
                <div class="live-nav-panel" id="live-nav-panel">
                  <div class="live-nav-header">
                    <div>
                      <h5 class="fw-bold mb-0">${state.planner.to}</h5>
                      <p class="live-nav-details">${selectedRoute.time}</p>
                    </div>
                    <button class="btn btn-danger" id="end-trip-btn">End</button>
                  </div>
                  <div class="live-nav-directions" id="live-nav-directions">
                    <p class="text-center p-3 text-secondary">Generating route...</p>
                  </div>
                </div>
              ` : ''}

              ${state.liveMap.vehicles.map(v => `
                <div id="${v.id}" class="live-vehicle" style="top: ${v.top}; left: ${v.left};">
                  <i class="${v.class}">${v.icon}</i>
                </div>
              `).join('')}

            </div>

            <div class="crowd-info-panel">
              <div class="row g-2">
                <div class="col crowd-stat">
                  <i class="bi bi-thermometer-half"></i>
                  <div class="crowd-stat-label">Thermal</div>
                  <div class="crowd-stat-value">28Â°C</div>
                </div>
                <div class="col crowd-stat">
                  <i class="bi bi-person-standing"></i>
                  <div class="crowd-stat-label">Seat Occupancy</div>
                  <div class="crowd-stat-value">72%</div>
                </div>
                <div class="col crowd-stat">
                  <i class="bi bi-bus-front"></i>
                  <div class="crowd-stat-label">Bus Wait</div>
                  <div class="crowd-stat-value">4 min</div>
                </div>
              </div>
              
              <div class="heat-map-label">Crowd Density Heat Map (Simulated)</div>
              <div class="vehicle-heatmap-container">
                <div class="vehicle-layout">
                  <div class="vehicle-zone zone-green span-2"></div>
                  <div class="vehicle-zone zone-green span-2"></div>
                  <div class="vehicle-zone zone-green"></div>
                  <div class="vehicle-zone zone-yellow"></div>
                  <div class="vehicle-zone zone-yellow"></div>
                  <div class="vehicle-zone zone-green"></div>
                  <div class="vehicle-zone zone-yellow"></div>
                  <div class="vehicle-zone zone-red"></div>
                  <div class="vehicle-zone zone-red"></div>
                  <div class="vehicle-zone zone-yellow"></div>
                  <div class="vehicle-zone zone-yellow"></div>
                  <div class="vehicle-zone zone-red"></div>
                  <div class="vehicle-zone zone-red"></div>
                  <div class="vehicle-zone zone-yellow"></div>
                  <div class="vehicle-zone zone-green"></div>
                  <div class="vehicle-zone zone-yellow"></div>
                  <div class="vehicle-zone zone-yellow"></div>
                  <div class="vehicle-zone zone-green"></div>
                </div>
              </div>

            </div>
          </div>
        `;

        attachMapListeners();
        initNavigationMap(); // This now draws the route AND directions
        startLiveVehicleSim();
      }
      
      function initStaticMap(elementId) {
        const mapElement = document.getElementById(elementId);
        if (!mapElement || !L) return;

        homeMapInstance = L.map(elementId, {
            center: [25.2048, 55.2708],
            zoom: 13,
            zoomControl: false,
            dragging: false,
            scrollWheelZoom: false,
            touchZoom: false,
        });
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: ''
        }).addTo(homeMapInstance);
      }

      /**
       * Initializes the Navigation Map.
       */
      function initNavigationMap() {
        const mapElement = document.getElementById('nav-map');
        if (!mapElement || !L) {
          console.error("Leaflet.js not loaded or map element not found.");
          return;
        }

        navMapInstance = L.map('nav-map').setView([25.2048, 55.2708], 13);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(navMapInstance);

        // Add routing IF the user is navigating
        if (state.planner.bookingState === 'navigating' && state.planner.to) {
          
          leafletRoutingControl = L.Routing.control({
            waypoints: [
              L.latLng(25.2048, 55.2708), // Start: "Current Location" (Dubai)
              L.latLng(...DESTINATION_COORDS[state.planner.to]) // End: Destination string
            ],
            /*
              **THE FIX IS HERE (Part 2)**
              'show: true' forces the plugin to run and draw all its
              layers (including the blue line).
              The CSS rule we added hides the text panel part.
            */
            show: true,
            createMarker: () => null, // Hide A/B markers
            lineOptions: {
                styles: [{color: 'var(--brand-primary)', opacity: 1, weight: 6}]
            },
            // This tells the plugin to NOT add its default
            // instruction panel to the map.
            addWaypoints: false,
            routeWhileDragging: false,
            fitSelectedRoutes: true
          }).addTo(navMapInstance);
          
          // Listen for routes and render directions
          leafletRoutingControl.on('routesfound', function(e) {
              const routes = e.routes;
              if (routes.length > 0 && routes[0].instructions) {
                  // Save all instructions to state
                  state.planner.directions = routes[0].instructions;
                  // Render them into the panel
                  renderDirectionsPanel();
              } else {
                  document.getElementById('live-nav-directions').innerHTML = 
                      '<p class="p-3 text-danger">Could not find a route.</p>';
              }
          });
        }
      }
      
      /**
       * This function renders the step-by-step directions
       */
      function renderDirectionsPanel() {
        const panel = document.getElementById('live-nav-directions');
        if (!panel || !state.planner.directions.length) return;
        
        panel.innerHTML = state.planner.directions.map(step => {
            // Format distance to be more readable
            let distance = step.distance > 1000 
                ? (step.distance / 1000).toFixed(1) + ' km'
                : Math.round(step.distance) + ' m';
                
            return `
              <div class="direction-step">
                <i class="bi ${getDirectionIcon(step.type)}"></i>
                <span class="direction-step-text">${step.text}</span>
                <span class="direction-step-dist">${distance}</span>
              </div>
            `;
        }).join('');
      }
      
      /**
       * Helper to get an icon for a direction type
       */
      function getDirectionIcon(type) {
        // This is a simplified mapping
        switch(type) {
          case 'Left': return 'bi-arrow-left';
          case 'Right': return 'bi-arrow-right';
          case 'Straight': return 'bi-arrow-up';
          case 'DestinationReached': return 'bi-geo-alt-fill';
          default: return 'bi-signpost-split';
        }
      }
      
      
      function stopAllMaps() {
        if (leafletRoutingControl) {
            try {
                if (navMapInstance) navMapInstance.removeControl(leafletRoutingControl);
            } catch(e) {}
            leafletRoutingControl = null;
        }
        if (navMapInstance) {
          navMapInstance.remove();
          navMapInstance = null;
        }
        if (homeMapInstance) {
          homeMapInstance.remove();
          homeMapInstance = null;
        }
      }


      function startLiveVehicleSim() {
        stopLiveVehicleSim(); 

        state.liveMap.vehicleSimInterval = setInterval(() => {
          state.liveMap.vehicles.forEach(v => {
            const vehicleEl = document.getElementById(v.id);
            if (vehicleEl) {
              let newTop = Math.random() * 80 + 10;
              let newLeft = Math.random() * 80 + 10; 
              vehicleEl.style.top = `${newTop}%`;
              vehicleEl.style.left = `${newLeft}%`;
            }
          });
        }, 4000); 
      }

      function stopLiveVehicleSim() {
        if (state.liveMap.vehicleSimInterval) {
          clearInterval(state.liveMap.vehicleSimInterval);
          state.liveMap.vehicleSimInterval = null;
        }
      }

      function attachMapListeners() {
        const whereToBtn = document.getElementById('where-to-btn');
        if (whereToBtn) {
          whereToBtn.addEventListener('click', () => {
            state.currentPage = 'home';
            state.planner.bookingState = 'idle';
            renderApp();
          });
        }

        const endTripBtn = document.getElementById('end-trip-btn');
        if (endTripBtn) {
          endTripBtn.addEventListener('click', () => {
            state.planner.bookingState = 'idle';
            state.planner.to = '';
            state.planner.directions = [];
            renderApp(); // Re-renders the map page
          });
        }
      }

      //================================================================
      // 7. REWARDS PAGE
      //================================================================

      function renderRewardsPage() {
        appContainer.innerHTML = `
          <div class="page rewards-page">
            <div class="rewards-header">
              <p>My Total Points</p>
              <h2>${state.user.totalPoints.toLocaleString()}</h2>
            </div>
            
            ${Object.keys(MOCK_REWARDS).map(category => `
              <div class="reward-category">
                <h4>${category}</h4>
                ${MOCK_REWARDS[category].map(reward => `
                  <div class="reward-card">
                    <div class="reward-card-icon">${reward.icon}</div>
                    <div class="reward-card-info">
                      <h6>${reward.name}</h6>
                      <p>${reward.points} Points</p>
                    </div>
                    <button class="btn btn-primary" data-reward-id="${reward.id}" data-reward-name="${reward.name}">
                      Redeem
                    </button>
                  </div>
                `).join('')}
              </div>
            `).join('')}
          </div>
        `;

        appContainer.querySelectorAll('.btn-primary[data-reward-id]').forEach(btn => {
      btn.addEventListener('click', () => {
        const rewardName = btn.dataset.rewardName;
        const rewardId = btn.dataset.rewardId; // Get the reward ID

        // --- NEW CODE ---
        
        // 1. Create a dynamic verification link. 
        // In a real app, this 'DUMMY-CODE' would come from the reward object.
        const verificationLink = `https://masa.ar/verify/${rewardId}-DUMMY-CODE`;

        // 2. Get the modal's image and link elements
        const qrImg = document.getElementById('redeemQR');
        const barcodeImg = document.getElementById('redeemBarcode');
        const redeemLink = document.getElementById('redeemLink');
        
        // 3. Set the href and text for the link
        redeemLink.href = verificationLink;
        redeemLink.textContent = verificationLink;

        // 4. Use APIs to set the image sources
        // We use encodeURIComponent to make the URL safe for the API
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(verificationLink)}`;
        barcodeImg.src = `https://barcode.tec-it.com/barcode.ashx?data=${encodeURIComponent(verificationLink)}&code=Code128&dpi=96`;

        // --- END NEW CODE ---

        redeemModalTitle.textContent = `Redeem: ${rewardName}`;
        redeemModal.show();
        console.log(`Redeeming ${rewardName}`);
      });
    });
      }

      //================================================================
      // 8. PROFILE PAGE
      //================================================================

      function renderProfilePage() {
        const user = state.user;

        appContainer.innerHTML = `
          <div class="page profile-page">
            <div class="profile-header">
              <div class="profile-img">
                ${user.profileImg 
                  ? `<img src="${user.profileImg}" alt="Profile">` 
                  : `<i class="bi bi-person-fill"></i>`
                }
              </div>
              <div class="profile-info">
                <h4>${user.name}</h4>
                <p>View and edit profile</p>
              </div>
            </div>
            
            ${(state.user.nolBalance > 0 && state.user.name !== 'Welcome User') ? `
              <div class="nol-balance-card">
                <h6>Nol Card Balance</h6>
                <h2>AED ${user.nolBalance.toFixed(2)}</h2>
              </div>
            ` : ''}

            <div class="profile-list-group">
              <a class="profile-list-item" data-bs-toggle="collapse" href="#tripHistoryCollapse" role="button">
                <i class="bi bi-clock-history"></i>
                <span>Trip History</span>
                <i class="bi bi-chevron-down small"></i>
              </a>
              <div class="collapse" id="tripHistoryCollapse">
                <div class="list-group list-group-flush px-3 pb-2">
                  ${user.tripHistory.map(trip => `
                    <div class="list-group-item coupon-item">
                      <div class="reward-card-icon">${getTripIcon(trip.type)}</div>
                      <div class="coupon-item-info">
                        <p>${trip.details}</p>
                        <small>${trip.date}</small>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <a class="profile-list-item" data-bs-toggle="collapse" href="#couponsCollapse" role="button">
                <i class="bi bi-ticket-perforated"></i>
                <span>Redeemed Coupons</span>
                <span class="badge bg-primary rounded-pill">${user.coupons.filter(c => c.status === 'unused').length}</span>
              </a>
              <div class="collapse" id="couponsCollapse">
                <div class="list-group list-group-flush px-3 pb-2">
                  ${user.coupons.map(coupon => `
                    <div class="list-group-item coupon-item">
                      <div class="coupon-item-info">
                        <p>${coupon.name}</p>
                        <small>${getCouponStatus(coupon)}</small>
                      </div>
                      ${getCouponBadge(coupon.status)}
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="profile-list-group">
              <div class="profile-list-item logout" id="logout-btn">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
              </div>
            </div>
            
          </div>
        `;

        document.getElementById('logout-btn').addEventListener('click', handleLogout);
      }

      // --- Profile Page Helpers ---
      function getTripIcon(type) {
        if (type === 'metro') return 'ðŸš‡';
        if (type === 'bus') return 'ðŸšŒ';
        if (type === 'tram') return 'ðŸš‹';
        return 'ðŸ“';
      }
      function getCouponStatus(coupon) {
        if (coupon.status === 'unused') return `Expires in: ${coupon.expires}`;
        if (coupon.status === 'used') return 'Used';
        if (coupon.status === 'expired') return 'Expired';
        return '';
      }
      function getCouponBadge(status) {
        if (status === 'unused') return `<span class="badge bg-success rounded-pill">Unused</span>`;
        if (status === 'used') return `<span class="badge bg-secondary rounded-pill">Used</span>`;
        if (status === 'expired') return `<span class="badge bg-danger rounded-pill">Expired</span>`;
        return '';
      }

      //================================================================
      // 9. APP INITIALIZATION
      //================================================================
      
      renderApp();

    });
  </script>

</body>
</html>